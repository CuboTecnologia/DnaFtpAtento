@model IEnumerable<DnaMais.Atento.Web.Models.GrupoUsuarioModel>
@{
    ViewBag.Title = "DNA+ | Atento";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<hr />
@if (TempData["newGrupo"] != null)
{
    <p style="color:#22862c">@TempData["newGrupo"]</p>
}

@if (TempData["updateGroup"] != null)
{
    <p style="color:#22862c">@TempData["updateGroup"]</p>
}


@Html.ActionLink("Voltar para Listagem de Arquivos", "ListarArquivo", "ControleArquivo", null, new { @class = "btn btn-primary" })
@Html.ActionLink("Criar Novo Grupo", "CriarGrupoUsuario", "Home", null, new { @class = "btn btn-primary" })

<hr />

<div class="row">
    <div class="col-lg-12">
        <div class="panel panel-default">
            <div class="panel-heading"><h2>Grupos Cadastrados</h2></div>
            <table id="table" class="table-bordered table-hover table-striped table-condensed" cellspacing="0" width="100%">
                <thead>
                    <tr>
                        <th>Nome do Grupo</th>
                        <th>Descrição</th>
                        <th>Gerenciamento</th>
                    </tr>
                </thead>
                <tbody>

                    @foreach (var item in Model)
                    {
                        <tr>
                            <td class="col-md-5">
                                @Html.DisplayFor(modelItem => item.Nome)
                            </td>
                            <td class="col-md-5">
                                @Html.DisplayFor(modelItem => item.Descricao)
                            </td>
                            <td nowrap class="col-md-1">

                                @if (Session["TipoUsuario"].ToString() == "A")
                                {
                                    @Html.ActionLink("Editar", "EditarGrupo", "Home", new { nomeGrupo = item.Nome, codigoGrupo = item.Codigo }, null)
                                    <label> | </label>
                                    @Html.ActionLink("Excluir", "DeletarGrupo", "Home", new { codGrupo = item.Codigo }, new { @class = "excluirGrupo" })
                                    <label> | </label>
                                    @Html.ActionLink("Membros", "DetalharGrupo", "Home", new { codigoGrupo = item.Codigo, nomeGrupo = item.Nome }, null)
                                }

                                else if (Session["CriadorGrupo"].ToString() != item.Criador)
                                {
                                    @Html.ActionLink("Editar", "EditarGrupo", "Home", new { nomeGrupo = item.Nome, codigoGrupo = item.Codigo }, null)
                                    <label> | </label>
                                    @Html.ActionLink("Excluir", "DeletarGrupo", "Home", new { codGrupo = item.Codigo }, new { @class = "excluirGrupo" })
                                    <label> | </label>
                                    @Html.ActionLink("Membros", "DetalharGrupo", "Home", new { codigoGrupo = item.Codigo, nomeGrupo = item.Nome }, null)
                                }

                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="dialog" title="Atenção!">
    <span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 50px 0;"></span>
    <p>Tem certeza que deseja excluir este grupo?</p>
</div>

<script>

    $(document).ready(function () {

        var excluirClick;

        $(".excluirGrupo").click(function (event) {
            $("#dialog").dialog("open");
            excluirClick = $(this);
            event.preventDefault();
        });

        $("#dialog").dialog({
            autoOpen: false,
            width: 400,
            buttons: [
                {
                    text: "Confirmar",
                    click: function () {

                        $.ajax({
                            type: "POST",
                            url: $(excluirClick).attr('href'),
                            datatype: 'json',
                            crossDomain: true,

                            success: function (data) {

                                $(excluirClick).closest('tr').fadeOut(500);

                                setTimeout(function () {
                                    $(excluirClick).closest('tr').after('<tr><td colspan="5" style="background-color:#22862c; color:#ffe9e9" id="grupoExcluido">Grupo excluído com sucesso.</td></tr>');
                                    $('#grupoExcluido').delay(1500).fadeOut(800);
                                }, 500);
                            },
                            error: function () {

                                $(excluirClick).closest('tr').fadeOut(500);

                                setTimeout(function () {
                                    $(excluirClick).closest('tr').after('<tr><td colspan="5" style="background-color:#a33e3e; color:#ffe9e9" id="falhaExclusao">Falha na exclusão. O grupo possui usuários cadastrados.</td></tr>');
                                    $('#falhaExclusao').delay(4000).fadeOut(800);
                                }, 500);

                                $(excluirClick).closest('tr').delay(4800).fadeIn(500);

                            }

                        });

                        $(this).dialog("close");

                    }
                },
                {
                    text: "Cancelar",
                    click: function () {

                        $(this).dialog("close");

                    }
                }
            ]
        });

    });

</script>
